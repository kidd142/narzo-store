---
// src/pages/admin/products/[id].astro
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { requireAdmin } from '../../../lib/auth';

const redirect = await requireAdmin(Astro);
if (redirect) return redirect;

const { id } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const isNew = id === 'new';

let product = null;
if (!isNew) {
  product = await db.prepare('SELECT * FROM products WHERE id = ?').bind(id).first();
  if (!product) return Astro.redirect('/admin/products');
}
---

<AdminLayout title={isNew ? 'New Product' : 'Edit Product'}>
  <h1 class="text-3xl font-bold mb-8">{isNew ? 'New Product' : 'Edit Product'}</h1>
  
  <form method="POST" action="/api/admin/products" class="bg-surface-50 p-6 rounded-xl border border-surface-100 max-w-2xl space-y-4">
    <input type="hidden" name="id" value={product?.id || crypto.randomUUID()} />
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Name (ID)</label>
      <input type="text" name="name_id" value={product?.name_id || ''} required
             class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none" />
    </div>
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Name (EN)</label>
      <input type="text" name="name_en" value={product?.name_en || ''}
             class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none" />
    </div>
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Slug</label>
      <input type="text" name="slug" value={product?.slug || ''} required
             class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none" />
    </div>
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Price (Rp)</label>
      <input type="number" name="price" value={product?.price || ''} required
             class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none" />
    </div>
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Description (ID)</label>
      <textarea name="description_id" rows="4"
                class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none"
      >{product?.description_id || ''}</textarea>
    </div>
    
    <div>
      <label class="block text-sm text-gray-400 mb-1">Image URL</label>
      <input type="text" name="image_url" value={product?.image_url || ''}
             class="w-full px-4 py-2 bg-surface border border-surface-100 rounded-lg focus:border-accent outline-none" />
    </div>
    
    <div class="flex items-center gap-4 pt-2">
      <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" name="is_active" value="1" checked={product?.is_active !== 0} class="w-4 h-4 text-accent bg-surface border-surface-100 rounded focus:ring-accent" />
        <span>Active</span>
      </label>
      <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" name="is_digital" value="1" checked={product?.is_digital} class="w-4 h-4 text-accent bg-surface border-surface-100 rounded focus:ring-accent" />
        <span>Digital Product</span>
      </label>
    </div>
    
    <div class="flex gap-4 pt-4">
      <button type="submit" class="bg-accent hover:bg-accent-hover text-white px-6 py-3 rounded-lg font-medium transition-colors">Save</button>
      <a href="/admin/products" class="px-6 py-3 border border-surface-100 rounded-lg text-gray-300 hover:text-white transition-colors">Cancel</a>
    </div>
  </form>
</AdminLayout>