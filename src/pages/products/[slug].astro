---
// src/pages/products/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getProductBySlug } from '../../lib/db';
import { t, translations } from '../../lib/i18n';

const { slug } = Astro.params;
const db = Astro.locals?.runtime?.env?.DB || null;
const product = await getProductBySlug(db, slug!);

if (!product) return Astro.redirect('/404');

const locale = (Astro.locals as any).locale || 'id';
const tr = translations.products;
const name = t({ id: product.name_id, en: product.name_en }, locale);
const desc = t({ id: product.description_id, en: product.description_en }, locale);

// Simple markdown to HTML converter
function parseMarkdown(text: string): string {
  if (!text) return '';
  return text
    // Bold **text**
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Bullet points
    .replace(/^â€¢ /gm, '<li>')
    .replace(/<li>(.+)$/gm, '<li>$1</li>')
    // Checkmarks
    .replace(/âœ…/g, '<span class="text-green-400">âœ…</span>')
    // Line breaks
    .replace(/\n\n/g, '</p><p class="mt-4">')
    .replace(/\n/g, '<br>');
}

const descHtml = parseMarkdown(desc || '');

// Check if payment is configured
const paymentEnabled = !!Astro.locals?.runtime?.env?.TRIPAY_API_KEY;

const digitalNote = locale === 'en' 
  ? 'ðŸ”— Digital product - link will be sent via email'
  : 'ðŸ”— Produk digital - link akan dikirim via email';
---

<BaseLayout title={name}>
  <div class="container mx-auto px-4 py-12">
    <div class="grid md:grid-cols-2 gap-12">
      <!-- Image -->
      <div>
        {product.image_url ? (
          <img src={product.image_url} alt={name}
               class="w-full rounded-xl" />
        ) : (
          <div class="w-full aspect-square bg-surface-50 rounded-xl flex items-center justify-center">
            <span class="text-gray-500">No Image</span>
          </div>
        )}
      </div>
      
      <!-- Details -->
      <div>
        <h1 class="text-4xl font-bold mb-4">{name}</h1>
        
        <p class="text-3xl font-bold text-accent mb-6">
          Rp {product.price.toLocaleString()}
        </p>
        
        {descHtml && (
          <div class="text-gray-400 mb-8 prose prose-invert prose-sm max-w-none">
            <p set:html={descHtml}></p>
          </div>
        )}
        
        {paymentEnabled ? (
          <a href={`/checkout/${product.id}`} class="btn-primary inline-block">
            {t(tr.buy_now, locale)}
          </a>
        ) : (
          <span class="inline-block px-6 py-3 bg-surface-50 rounded-lg text-gray-500">
            Coming Soon
          </span>
        )}
        
        {product.is_digital && (
          <p class="mt-4 text-sm text-gray-500">
            {digitalNote}
          </p>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
