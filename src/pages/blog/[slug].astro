---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AdSlot from '../../components/AdSlot.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { getPostBySlug, getRelatedPosts, incrementViews } from '../../lib/db';
import { t, translations, getLocalizedArticle } from '../../lib/i18n';
import { injectAdsAfterH2, splitContentForAds } from '../../lib/content-ads';

const { slug } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const post = await getPostBySlug(db, slug!);

if (!post) return Astro.redirect('/404');

await incrementViews(db, post.id);

const locale = (Astro.locals as any).locale || 'id';
const tr = translations.blog;
const { title, excerpt } = getLocalizedArticle(post, locale);
let content = t({ id: post.content_id, en: post.content_en }, locale);

// Calculate reading time (avg 200 words per minute)
const wordCount = content?.replace(/<[^>]*>/g, '').split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Get related posts by category
const relatedPosts = await getRelatedPosts(db, post.category, post.id, 3);

const pageUrl = `https://narzo.store/blog/${post.slug}`;
const enableAds = post.enable_ads === 1;

// Dynamic OG image - use article cover or fallback
const ogImage = post.cover_image || 'https://narzo.store/og-image.svg';

// Article structured data (BlogPosting schema)
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": excerpt || '',
  "image": ogImage,
  "datePublished": post.created_at,
  "dateModified": post.updated_at || post.created_at,
  "author": {
    "@type": "Organization",
    "name": "Narzo Store"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Narzo Store",
    "logo": {
      "@type": "ImageObject",
      "url": "https://narzo.store/favicon.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": pageUrl
  },
  "wordCount": wordCount,
  "articleSection": post.category || "Blog",
  "keywords": post.tags || ""
};

// Breadcrumb structured data
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": locale === 'id' ? "Beranda" : "Home",
      "item": "https://narzo.store"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://narzo.store/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": title,
      "item": pageUrl
    }
  ]
};

// Inject mid-article ads after 2nd H2 heading (if ads enabled and content is long enough)
let contentSegments: string[] = [content || ''];
if (enableAds && wordCount > 300) {
  const contentWithAds = injectAdsAfterH2(content || '', [1]);
  contentSegments = splitContentForAds(contentWithAds);
}
---

<BaseLayout 
  title={title} 
  description={excerpt || ''} 
  showHeaderAd={enableAds}
  ogImage={ogImage}
>
  <!-- Article Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} slot="head" />
  
  <div class="container mx-auto px-4 py-12">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm" aria-label="Breadcrumb">
      <ol class="flex items-center gap-2 text-gray-400">
        <li>
          <a href="/" class="hover:text-accent transition-colors">
            {locale === 'id' ? 'Beranda' : 'Home'}
          </a>
        </li>
        <li class="flex items-center gap-2">
          <span>›</span>
          <a href="/blog" class="hover:text-accent transition-colors">Blog</a>
        </li>
        {post.category && (
          <li class="flex items-center gap-2">
            <span>›</span>
            <a href={`/blog?category=${post.category}`} class="hover:text-accent transition-colors">
              {post.category}
            </a>
          </li>
        )}
        <li class="flex items-center gap-2">
          <span>›</span>
          <span class="text-gray-400 truncate max-w-[200px]">{title}</span>
        </li>
      </ol>
    </nav>

    <div class="grid lg:grid-cols-[1fr_300px] gap-8">
      <!-- Article Content -->
      <article class="max-w-3xl">
        {post.cover_image && (
          <img src={post.cover_image} alt={title}
               class="w-full h-64 md:h-96 object-cover rounded-xl mb-8"
               loading="eager"
               decoding="async"
               fetchpriority="high" />
        )}
        
        <h1 class="text-3xl md:text-4xl font-bold mb-4">{title}</h1>
        
        <div class="flex flex-wrap gap-4 text-gray-400 mb-6">
          {post.category && (
            <a href={`/blog?category=${post.category}`} class="badge-info hover:bg-accent/30 transition-colors">
              {post.category}
            </a>
          )}
          <span>•</span>
          <span>{readingTime} {t(tr.min_read, locale)}</span>
          <span>•</span>
          <span>{post.views} {t(tr.views, locale)}</span>
          <span>•</span>
          <time datetime={post.created_at}>
            {new Date(post.created_at).toLocaleDateString(locale === 'id' ? 'id-ID' : 'en-US', { 
              day: 'numeric', 
              month: 'long', 
              year: 'numeric' 
            })}
          </time>
        </div>
        
        <!-- Share buttons -->
        <ShareButtons url={pageUrl} title={title} />
        
        <!-- In-article ad (top) - only for shorter articles -->
        {enableAds && wordCount <= 300 && <AdSlot slot="in-article" class="my-8" />}
        
        <!-- Article content with mid-article ads -->
        <div class="prose-dark mt-8">
          {contentSegments.map((segment, index) => (
            <>
              <Fragment set:html={segment} />
              {/* Insert mid-article ad between segments (not after last) */}
              {enableAds && index < contentSegments.length - 1 && (
                <div class="my-8 py-4 border-y border-surface-100/30">
                  <AdSlot slot="in-article" />
                </div>
              )}
            </>
          ))}
        </div>
        
        <!-- In-article ad (bottom) -->
        {enableAds && <AdSlot slot="in-article" class="my-8" />}
        
        <!-- Tags -->
        {post.tags && (
          <div class="flex flex-wrap gap-2 mt-8 pt-8 border-t border-surface-100">
            {post.tags.split(',').map(tag => (
              <span class="px-3 py-1 bg-surface-50 rounded-full text-sm text-gray-400">
                #{tag.trim()}
              </span>
            ))}
          </div>
        )}
        
        <!-- Share buttons bottom -->
        <div class="mt-8 pt-8 border-t border-surface-100">
          <p class="text-gray-400 mb-4">{t(tr.share, locale)}:</p>
          <ShareButtons url={pageUrl} title={title} />
        </div>
      </article>
      
      <!-- Sidebar -->
      <aside class="hidden lg:block">
        <div class="sticky top-20">
          {enableAds && <AdSlot slot="sidebar" />}
        </div>
      </aside>
    </div>
  </div>
  
  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <section class="container mx-auto px-4 py-12 border-t border-surface-100">
      <h2 class="text-2xl font-bold mb-8">{t(tr.related, locale)}</h2>
      <RelatedPosts posts={relatedPosts} {locale} />
    </section>
  )}
  
  <!-- Multiplex Ad (recommendation-style ads) -->
  {enableAds && (
    <section class="container mx-auto px-4 py-8">
      <AdSlot slot="multiplex" />
    </section>
  )}
</BaseLayout>
