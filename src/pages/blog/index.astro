---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getPosts, getPostsCount, getCategories } from '../../lib/db';
import { t, translations } from '../../lib/i18n';

const db = Astro.locals.runtime.env.DB;
const categories = await getCategories(db);
const locale = (Astro.locals as any).locale || 'id';
const tr = translations.blog;

// Get params from URL
const url = new URL(Astro.request.url);
const activeCategory = url.searchParams.get('category');
const currentPage = parseInt(url.searchParams.get('page') || '1');

// Pagination config
const POSTS_PER_PAGE = 9;
const offset = (currentPage - 1) * POSTS_PER_PAGE;

// Get posts and total count
const [posts, totalPosts] = await Promise.all([
  getPosts(db, { 
    limit: POSTS_PER_PAGE,
    offset,
    category: activeCategory || undefined
  }),
  getPostsCount(db, {
    category: activeCategory || undefined
  })
]);

const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);

// Find active parent category for showing children
const activeParent = categories.find(cat => 
  cat.slug === activeCategory || 
  (cat.children && cat.children.some(child => child.slug === activeCategory))
);

// Build pagination URL helper
function getPaginationUrl(page: number) {
  const params = new URLSearchParams();
  if (activeCategory) params.set('category', activeCategory);
  if (page > 1) params.set('page', page.toString());
  const queryString = params.toString();
  return `/blog${queryString ? '?' + queryString : ''}`;
}
---

<BaseLayout title={t(tr.title, locale)}>
  <div class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8">{t(tr.title, locale)}</h1>
    
    <!-- Category Filter -->
    <div class="mb-8">
      <div class="flex flex-wrap gap-2">
        <a 
          href="/blog" 
          class:list={[
            "px-4 py-2 rounded-full text-sm font-medium transition-colors",
            !activeCategory 
              ? "bg-accent text-white" 
              : "bg-surface-100 text-gray-300 hover:bg-surface-50"
          ]}
        >
          {locale === 'id' ? 'Semua' : 'All'}
        </a>
        {categories.map(cat => (
          <a 
            href={`/blog?category=${cat.slug}`}
            class:list={[
              "px-4 py-2 rounded-full text-sm font-medium transition-colors inline-flex items-center gap-1",
              activeCategory === cat.slug 
                ? "bg-accent text-white" 
                : "bg-surface-100 text-gray-300 hover:bg-surface-50"
            ]}
          >
            <span>{cat.icon}</span>
            <span>{locale === 'id' ? cat.name_id : (cat.name_en || cat.name_id)}</span>
            {cat.children && cat.children.length > 0 && (
              <span class="text-xs opacity-60">+{cat.children.length}</span>
            )}
          </a>
        ))}
      </div>
      
      <!-- Child categories (if parent selected) -->
      {activeParent && activeParent.children && activeParent.children.length > 0 && (
        <div class="mt-3 pl-4 flex flex-wrap gap-2">
          {activeParent.children.map(child => (
            <a 
              href={`/blog?category=${child.slug}`}
              class:list={[
                "px-3 py-1 rounded-full text-xs font-medium transition-colors inline-flex items-center gap-1",
                activeCategory === child.slug
                  ? "bg-accent/20 text-accent"
                  : "bg-surface-50 text-gray-400 hover:text-accent"
              ]}
            >
              <span>{child.icon}</span>
              <span>{locale === 'id' ? child.name_id : (child.name_en || child.name_id)}</span>
            </a>
          ))}
        </div>
      )}
    </div>
    
    <!-- Posts Grid -->
    <div class="grid md:grid-cols-3 gap-6">
      {posts.map(post => (
        <ArticleCard post={post} locale={locale} />
      ))}
    </div>
    
    {posts.length === 0 && (
      <p class="text-gray-400 text-center py-12">
        {t(tr.no_posts, locale)}
      </p>
    )}
    
    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="mt-12 flex justify-center items-center gap-2">
        <!-- Previous -->
        {currentPage > 1 ? (
          <a 
            href={getPaginationUrl(currentPage - 1)}
            class="px-4 py-2 rounded-lg bg-surface-100 text-gray-300 hover:bg-surface-50 transition-colors"
          >
            ← {locale === 'id' ? 'Sebelumnya' : 'Previous'}
          </a>
        ) : (
          <span class="px-4 py-2 rounded-lg bg-surface-100 text-gray-400 opacity-50 cursor-not-allowed">
            ← {locale === 'id' ? 'Sebelumnya' : 'Previous'}
          </span>
        )}
        
        <!-- Page Numbers -->
        <div class="flex items-center gap-1">
          {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
            <a
              href={getPaginationUrl(page)}
              class:list={[
                "w-10 h-10 flex items-center justify-center rounded-lg text-sm font-medium transition-colors",
                page === currentPage
                  ? "bg-accent text-white"
                  : "bg-surface-100 text-gray-300 hover:bg-surface-50"
              ]}
            >
              {page}
            </a>
          ))}
        </div>
        
        <!-- Next -->
        {currentPage < totalPages ? (
          <a 
            href={getPaginationUrl(currentPage + 1)}
            class="px-4 py-2 rounded-lg bg-surface-100 text-gray-300 hover:bg-surface-50 transition-colors"
          >
            {locale === 'id' ? 'Selanjutnya' : 'Next'} →
          </a>
        ) : (
          <span class="px-4 py-2 rounded-lg bg-surface-100 text-gray-400 opacity-50 cursor-not-allowed">
            {locale === 'id' ? 'Selanjutnya' : 'Next'} →
          </span>
        )}
      </div>
    )}
    
    <!-- Post Count Info -->
    {totalPosts > 0 && (
      <p class="mt-6 text-center text-sm text-gray-400">
        {locale === 'id' 
          ? `Menampilkan ${offset + 1}-${Math.min(offset + posts.length, totalPosts)} dari ${totalPosts} artikel`
          : `Showing ${offset + 1}-${Math.min(offset + posts.length, totalPosts)} of ${totalPosts} articles`
        }
      </p>
    )}
  </div>
</BaseLayout>
