---
// src/pages/order/[ref].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { t } from '../../lib/i18n';

const { ref } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const locale = (Astro.locals as any).locale || 'id';

const tx = await db.prepare(`
  SELECT t.*, p.name_id, p.name_en, p.is_digital, t.download_token, t.downloads_used, t.max_downloads
  FROM transactions t
  LEFT JOIN products p ON t.product_id = p.id
  WHERE t.reference = ?
`).bind(ref).first();

const productName = tx ? t({ id: tx.name_id, en: tx.name_en }, locale) : '';

// Translations
const tr = {
  orderStatus: locale === 'en' ? 'Order Status' : 'Status Pesanan',
  product: locale === 'en' ? 'Product' : 'Produk',
  amount: locale === 'en' ? 'Amount' : 'Jumlah',
  email: locale === 'en' ? 'Email' : 'Email',
  date: locale === 'en' ? 'Date' : 'Tanggal',
  downloadProduct: locale === 'en' ? 'Download Product' : 'Unduh Produk',
  downloadsUsed: locale === 'en' ? 'downloads used' : 'unduhan digunakan',
  waitingPayment: locale === 'en' ? 'Waiting for payment...' : 'Menunggu pembayaran...',
  completePayment: locale === 'en' 
    ? 'Please complete your payment via the link provided during checkout.' 
    : 'Silakan selesaikan pembayaran melalui link yang diberikan saat checkout.',
  orderNotFound: locale === 'en' ? 'Order not found' : 'Pesanan tidak ditemukan',
  checkReference: locale === 'en' ? 'Please check your reference number' : 'Silakan periksa nomor referensi Anda',
  checkAnother: locale === 'en' ? 'Check Another Order' : 'Cek Pesanan Lain',
  orderRef: locale === 'en' ? 'Order reference' : 'Referensi pesanan',
  check: locale === 'en' ? 'Check' : 'Cek',
};
---

<BaseLayout title={tr.orderStatus}>
  <div class="container mx-auto px-4 py-12 max-w-lg">
    {tx ? (
      <div class="card">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">Order #{ref}</h1>
          <span class={`badge ${
            tx.status === 'paid' ? 'badge-success' :
            tx.status === 'expired' ? 'badge-error' :
            'badge-warning'
          }`}>
            {tx.status.toUpperCase()}
          </span>
        </div>
        
        <dl class="space-y-4">
          <div>
            <dt class="text-sm text-gray-500">{tr.product}</dt>
            <dd class="font-medium">{productName}</dd>
          </div>
          <div>
            <dt class="text-sm text-gray-500">{tr.amount}</dt>
            <dd class="font-medium text-accent">Rp {tx.amount.toLocaleString('id-ID')}</dd>
          </div>
          <div>
            <dt class="text-sm text-gray-500">{tr.email}</dt>
            <dd class="font-medium">{tx.customer_email}</dd>
          </div>
          <div>
            <dt class="text-sm text-gray-500">{tr.date}</dt>
            <dd class="font-medium">{tx.created_at}</dd>
          </div>
        </dl>
        
        {tx.status === 'paid' && tx.is_digital && tx.download_token && (
          <div class="mt-6 pt-6 border-t border-surface-100">
            <a href={`/api/download/${tx.download_token}`} class="btn-primary w-full text-center">
              {tr.downloadProduct}
            </a>
            <p class="text-sm text-gray-500 mt-2">
              {tx.downloads_used}/{tx.max_downloads} {tr.downloadsUsed}
            </p>
          </div>
        )}
        
        {tx.status === 'pending' && (
          <div class="mt-6">
            <div class="alert-warning">
              <p>{tr.waitingPayment}</p>
              <p class="text-sm mt-2">{tr.completePayment}</p>
            </div>
          </div>
        )}
      </div>
    ) : (
      <div class="empty-state">
        <span class="text-4xl mb-4">üîç</span>
        <h2 class="text-xl font-bold mb-2">{tr.orderNotFound}</h2>
        <p class="text-gray-500">{tr.checkReference}</p>
      </div>
    )}
    
    <!-- Order lookup form -->
    <div class="card mt-8">
      <h3 class="font-bold mb-4">{tr.checkAnother}</h3>
      <form action="/order" method="get" class="flex gap-2">
        <input type="text" name="ref" placeholder={tr.orderRef} class="input flex-1" required />
        <button type="submit" class="btn-primary">{tr.check}</button>
      </form>
    </div>
  </div>
</BaseLayout>
