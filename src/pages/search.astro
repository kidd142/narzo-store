---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import type { Post } from '../lib/db';
import { t, translations } from '../lib/i18n';

const rawQuery = Astro.url.searchParams.get('q') || '';
// Sanitize query - remove HTML tags and limit length
const query = rawQuery.replace(/<[^>]*>/g, '').slice(0, 100);
const db = Astro.locals.runtime.env.DB;
const locale = (Astro.locals as any).locale || 'id';

let posts: Post[] = [];

if (query.length >= 2) {
  const q = `%${query}%`;
  
  // Search posts only (products disabled)
  const postResults = await db.prepare(`
    SELECT * FROM posts WHERE published = 1 
    AND (title_id LIKE ? OR title_en LIKE ? OR excerpt_id LIKE ? OR excerpt_en LIKE ?)
    ORDER BY views DESC LIMIT 20
  `).bind(q, q, q, q).all<Post>();
  posts = postResults.results || [];
}

const totalResults = posts.length;

// Translations
const trLocal = {
  title: locale === 'en' ? 'Search' : 'Pencarian',
  placeholder: locale === 'en' ? 'Search articles...' : 'Cari artikel...',
  results: locale === 'en' ? 'results found' : 'hasil ditemukan',
  noResults: locale === 'en' ? 'No results found' : 'Tidak ada hasil',
  tryDifferent: locale === 'en' ? 'Try different keywords' : 'Coba kata kunci lain',
};
---

<BaseLayout title={`${trLocal.title}: ${query}`}>
  <div class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8">{trLocal.title}</h1>
    
    <!-- Search Form -->
    <form action="/search" method="GET" class="mb-8">
      <div class="flex flex-col md:flex-row gap-4">
        <input type="search" name="q" value={query}
               placeholder={trLocal.placeholder}
               class="flex-1 px-4 py-3 bg-surface-50 border border-surface-100 
                      rounded-lg focus:outline-none focus:border-accent" />
        <button type="submit" class="btn-primary px-8">
          {trLocal.title}
        </button>
      </div>
    </form>
    
    {query && <p class="text-gray-500 mb-6">{totalResults} {trLocal.results}</p>}
    
    {totalResults === 0 && query && (
      <div class="text-center py-12">
        <span class="text-4xl mb-4 block">üîç</span>
        <h2 class="text-xl font-bold mb-2">{trLocal.noResults}</h2>
        <p class="text-gray-500">{trLocal.tryDifferent}</p>
      </div>
    )}
    
    <!-- Blog Results -->
    {posts.length > 0 && (
      <div class="grid md:grid-cols-3 gap-6">
        {posts.map(post => <ArticleCard post={post} locale={locale} />)}
      </div>
    )}
  </div>
</BaseLayout>
