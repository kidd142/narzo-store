---
import Layout from '../../layouts/Layout.astro';

const { token } = Astro.params;
const env = Astro.locals.runtime.env;
const DB = env.DB;

if (!token) {
  return Astro.redirect('/');
}

let transaction = null;
let product = null;
let error = null;

if (DB) {
  // 1. Find transaction by library_token
  transaction = await DB.prepare(`
    SELECT * FROM transactions WHERE library_token = ?
  `).bind(token).first();

  if (transaction) {
    // 2. Find product details
    product = await DB.prepare(`
      SELECT * FROM products WHERE id = ?
    `).bind(transaction.product_id).first();

    // 3. Check/Refresh Download Token if needed
    // If token is expired or close to expiry (within 1 hour), refresh it
    const now = new Date();
    const expires = new Date(transaction.download_expires);
    const isExpired = expires < now;

    if (isExpired && transaction.downloads_used < transaction.max_downloads) {
      const newDownloadToken = crypto.randomUUID();
      // Set new expiry (e.g., 24 hours from now)
      // SQLite datetime needs specific format or unix epoch. Using '+1 day'.
      await DB.prepare(`
        UPDATE transactions 
        SET download_token = ?, download_expires = datetime('now', '+1 day')
        WHERE library_token = ?
      `).bind(newDownloadToken, token).run();
      
      // Update local object
      transaction.download_token = newDownloadToken;
    }
  } else {
    error = "Invalid Library Token";
  }
}

if (!transaction) {
  return Astro.redirect('/');
}

const remainingDownloads = transaction.max_downloads - transaction.downloads_used;
const isLimitReached = remainingDownloads <= 0;
---

<Layout title={`Library - ${product?.name_id || 'Digital Item'}`}>
  <div class="min-h-screen bg-slate-900 flex flex-col items-center py-12 px-4">
    
    <div class="max-w-2xl w-full bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
      
      {/* Header / Product Image */}
      <div class="h-48 bg-slate-700 relative overflow-hidden">
        {product?.image_url ? (
          <img 
            src={product.image_url} 
            alt={product.name_id} 
            class="w-full h-full object-cover opacity-80"
          />
        ) : (
          <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-600">
            <span class="text-4xl">ðŸ“¦</span>
          </div>
        )}
        <div class="absolute inset-0 bg-gradient-to-t from-slate-800 to-transparent"></div>
        <div class="absolute bottom-4 left-6">
          <h1 class="text-3xl font-bold text-white shadow-black drop-shadow-lg">
            {product?.name_id || transaction.product_name}
          </h1>
          <p class="text-slate-300 text-sm mt-1">
            Purchased on {new Date(transaction.paid_at * 1000).toLocaleDateString()}
          </p>
        </div>
      </div>

      <div class="p-8 space-y-8">
        
        {/* Status Section */}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-slate-700/50 p-4 rounded-xl text-center border border-slate-600">
            <span class="block text-slate-400 text-xs uppercase tracking-wider mb-1">Status</span>
            <span class="text-green-400 font-bold">Active</span>
          </div>
          <div class="bg-slate-700/50 p-4 rounded-xl text-center border border-slate-600">
            <span class="block text-slate-400 text-xs uppercase tracking-wider mb-1">Downloads Used</span>
            <span class="text-white font-bold">{transaction.downloads_used} / {transaction.max_downloads}</span>
          </div>
          <div class="bg-slate-700/50 p-4 rounded-xl text-center border border-slate-600">
            <span class="block text-slate-400 text-xs uppercase tracking-wider mb-1">Expires In</span>
            <span class="text-blue-400 font-bold">24 Hours</span>
          </div>
        </div>

        {/* Action Section */}
        <div class="text-center space-y-4">
          {!isLimitReached ? (
            <a 
              href={`/api/download/${transaction.download_token}`}
              class="block w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold text-xl rounded-xl shadow-lg shadow-blue-600/20 transform transition hover:-translate-y-1"
            >
              Download File
            </a>
          ) : (
            <button disabled class="block w-full py-4 bg-slate-600 text-slate-400 font-bold text-xl rounded-xl cursor-not-allowed">
              Download Limit Reached
            </button>
          )}
          
          <p class="text-slate-500 text-sm">
            Please download and save the file immediately. Link expires for security.
          </p>
        </div>

        {/* Product Details */}
        <div class="prose prose-invert max-w-none">
          <h3 class="text-white border-b border-slate-700 pb-2">Description</h3>
          <p class="text-slate-300 mt-4">
            {product?.description_id || "No description available."}
          </p>
        </div>

      </div>
      
      {/* Footer */}
      <div class="bg-slate-900/50 p-4 text-center border-t border-slate-700">
        <p class="text-xs text-slate-500">Transaction Ref: {transaction.reference || transaction.merchant_ref}</p>
      </div>

    </div>
  </div>
</Layout>
