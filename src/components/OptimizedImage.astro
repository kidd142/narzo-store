---
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  fit?: 'scale-down' | 'contain' | 'cover' | 'crop' | 'pad';
}

const {
  src,
  alt,
  width,
  height,
  class: className,
  fit = 'cover'
} = Astro.props;

// Helper to construct Cloudflare Image Resizing URL
function getOptimizedUrl(url: string, w?: number, h?: number, f?: string) {
  // Only optimize in production/preview
  if (import.meta.env.DEV) return url;
  
  // For external URLs (like Unsplash), use them directly
  // Cloudflare Image Resizing may not work with external origins
  if (url.startsWith('http://') || url.startsWith('https://')) {
    // External image - use as-is (Unsplash already provides resizing via URL params)
    return url;
  }
  
  // For local assets, use Cloudflare Image Resizing
  const options = [];
  if (w) options.push(`width=${w}`);
  if (h) options.push(`height=${h}`);
  if (f) options.push(`fit=${f}`);
  options.push('format=auto');
  options.push('quality=80');
  
  const optionsString = options.join(',');
  return `/cdn-cgi/image/${optionsString}${url}`;
}

const optimizedSrc = getOptimizedUrl(src, width, height, fit);
---

<img 
  src={optimizedSrc} 
  alt={alt} 
  width={width} 
  height={height} 
  class={className} 
  loading="lazy" 
  decoding="async" 
/>
